<template>
    <lightning-card>
        <template if:true={isLoading}>
            <lightning-spinner alternative-text="Loading" size="small"></lightning-spinner>
        </template>

        <h3 slot="title">
            <lightning-icon icon-name="custom:custom23" size="small" class="slds-var-m-right_small"></lightning-icon>
            What's That Email?
        </h3>
        <div slot="actions">
            {get_recordCounter}
            <template if:true={get_showBackButton}>
                <lightning-button-icon 
                    icon-name="utility:close" 
                    size="small"
                    onclick={backToSearch}
                    class="slds-var-m-left_small"
                    title="Back to Search">
                </lightning-button-icon>
            </template>
            
        </div>

        <!-- SEARCH LAYOUT -->
        <template if:true={showSearchBar}>
            <template if:true={get_validateSelectedFilters}>
                <div class="slds-var-p-horizontal_large slds-var-m-bottom_xx-small">
                    <lightning-input
                        name="enter-search"
                        placeholder="Enter User Name or Email & Hit Enter"
                        type="search"
                        onkeypress={searchUsers}
                        onchange={handleSearchChange}
                        variant="label-hidden"
                    ></lightning-input>
                </div>
            </template>

            <template if:false={get_validateSelectedFilters}>
                <!-- Filter Validation -->
                <div class="slds-var-m-horizontal_large slds-var-m-bottom_small slds-var-m-top_medium">
                    <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                    &nbsp; <span style="color: rgb(151, 6, 6)">At least <b>To Address</b> or <b>From Address</b> filters are required to search</span>
                </div>
            </template>
            
            <div class="slds-var-m-horizontal_large slds-var-m-bottom_medium filtersContainer">
                <div class="slds-grid">
                    <div class="slds-col slds-size_2-of-12">
                        Search Fields:
                    </div>
                    <div class="slds-col slds-size_1-of-12">
                        <lightning-input 
                            type="toggle" 
                            checked={filterFromAddress} 
                            onchange={toggleFilterFromAddress} 
                            variant="label-hidden" 
                            message-toggle-active="From Add"
                            message-toggle-inactive="From Add" 
                        ></lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-12">
                        <lightning-input 
                            type="toggle" 
                            checked={filterToAddress} 
                            onchange={toggleFilterToAddress} 
                            variant="label-hidden" 
                            message-toggle-active="To Add"
                            message-toggle-inactive="To Add"
                        ></lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-12">
                        <lightning-input 
                            type="toggle" 
                            checked={filterCCAddress} 
                            onchange={toggleFilterCCAddress} 
                            variant="label-hidden" 
                            message-toggle-active="CC Add"
                            message-toggle-inactive="CC Add"
                        ></lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-12">
                        <lightning-input 
                            type="toggle" 
                            checked={filterBCCAddress} 
                            onchange={toggleFilterBCCAddress} 
                            variant="label-hidden" 
                            message-toggle-active="BCC Add"
                            message-toggle-inactive="BCC Add"
                        ></lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-12">
                        <lightning-input 
                            type="toggle" 
                            checked={filterFromName} 
                            onchange={toggleFilterFromName} 
                            variant="label-hidden"  
                            message-toggle-active="From Name"
                            message-toggle-inactive="From Name"
                        ></lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-12">
                        <lightning-input 
                            type="toggle" 
                            checked={filterSubject} 
                            onchange={toggleFilterSubject} 
                            variant="label-hidden" 
                            message-toggle-active="Subject"
                            message-toggle-inactive="Subject"
                        ></lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-12">
                        <lightning-input 
                            type="toggle" 
                            checked={filterCongaSolutions} 
                            onchange={toggleFilterCongaSolution} 
                            variant="label-hidden" 
                            message-toggle-active="Conga Solutions"
                            message-toggle-inactive="Conga Solutions"
                            disabled={get_disableCongaFilter}
                        ></lightning-input>
                    </div>
                </div>
                
            </div>
            
    
            <template lwc:if={foundUsers}>
                <p class="slds-var-m-horizontal_large slds-var-m-bottom_small">Select a user to search using their details, or select to search by search term entered:</p>
                <div style="max-height: 500px" class="slds-scrollable_y">
                    <template for:each={users} for:item="user">
                        <div class="userContainer slds-var-m-horizontal_large" 
                            key={user.id}
                            onclick={selectUser}
                            data-id={user.Id}
                            data-username={user.Name}
                            data-useremail={user.Email}>
                            <div class="slds-grid">
                                <div class="slds-col slds-size_1-of-2 slds-truncate">
                                    <lightning-icon icon-name="utility:user" size="x-small"></lightning-icon>
                                    <span title={user.Name} class="slds-var-m-left_x-small">{user.Name}</span>
                                </div>
                                <div class="slds-col slds-size_1-of-2 slds-truncate">
                                    <span title={user.Email} class="slds-var-m-left_x-small">{user.Email}</span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="slds-var-m-horizontal_large slds-var-m-bottom_large feedbackContainer"
                onclick={searchEmailsWithTerm}>
                <lightning-icon icon-name="utility:search" size="x-small"></lightning-icon>
                &nbsp; &nbsp; Click here to search emails directly for '<b>{searchTerm}</b>'
            </div>
            </template>
        </template>

        <!-- SEARCH BY USER RESULTS-->
        <template if:true={selectedUserId}>
            <div class="searchCriteriaContainer slds-var-m-horizontal_large">
                <div class="slds-grid">
                    <div class="slds-col slds-size_1-of-2 slds-truncate">
                        <lightning-icon icon-name="utility:user" size="x-small"></lightning-icon>
                        <span title={selectedUserName} class="slds-var-m-left_x-small">{selectedUserName}</span>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-truncate">
                        <span title={selectedUserEmail} class="slds-var-m-left_x-small">{selectedUserEmail}</span>
                    </div>
                </div>
            </div>

            <div style="max-height: 500px" class="slds-scrollable_y">
                <div class="sectionHeader slds-var-m-horizontal_large slds-var-m-top_medium lds-var-m-bottom_x-small">
                    <lightning-icon icon-name="utility:email" size="x-small"></lightning-icon>
                    <span title="Email Messages" class="slds-var-m-left_x-small">Email Messages</span>
                </div>
                <template for:each={emailMessages} for:item="email">
                    <div key={email.Id} class="searchResultContainer slds-var-m-horizontal_large">

                        <lightning-layout horizontal-align="spread">       
                            <lightning-layout-item size="7" class=""> 
                                <p class="slds-truncate"><b>From: </b>{email.FromAddress}</p>
                                <p class="slds-truncate"><b>To: </b>{email.ToAddress}</p>

                            </lightning-layout-item>
                            <lightning-layout-item size="4" class="">
                                    <div class="slds-grid slds-grid_align-end">
                                        <div class="slds-col slds-var-m-right_small">
                                            <div class="statContainerTask">
                                                <lightning-formatted-date-time value={email.MessageDate} title="Email Sent Date"></lightning-formatted-date-time>
                                            </div> 
                                        </div>
                                        <template if:true={email.hasEmailTemplateID}>
                                            <div class="slds-col slds-var-m-right_xx-small">
                                                <lightning-button-icon 
                                                    icon-name="utility:component_customization" 
                                                    variant="border-filled" 
                                                    size="small" 
                                                    alternative-text="Go to Email Template Id" 
                                                    title="Go to Email Template ID"
                                                    onclick={goToRecord}
                                                    data-link={email.emailTemplateLink}>
                                                </lightning-button-icon>
                                            </div>
                                        </template>
                                        
                                        <div class="slds-col">
                                            <lightning-button-icon 
                                                icon-name="utility:email" 
                                                variant="border-filled" 
                                                size="small" 
                                                alternative-text="View Email" 
                                                title="View Email"
                                                onclick={goToRecord}
                                                data-link={email.emailMessageLink}>
                                            </lightning-button-icon>
                                        </div>
                                    </div>
                            </lightning-layout-item>     
                        </lightning-layout>

                        <lightning-layout horizontal-align="spread" class="slds-var-m-top_small">       
                            <lightning-layout-item size="12" class="slds-truncate"> 
                                <p class="slds-truncate sld-var-m-top_small" style="white-space:normal;">
                                    <b>Subject: </b><lightning-formatted-text value={email.Subject}></lightning-formatted-text>
                                </p>
                            </lightning-layout-item>    
                        </lightning-layout>
                    </div>
                </template>
            

                <template if:false={get_emailMessagesFound}>
                    <div class="slds-var-m-horizontal_large slds-var-m-bottom_large slds-var-m-top_medium">
                        <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                        &nbsp; No Messages Found...
                    </div>
                </template>



                <!-- CONGA SOLUTIONS -->
                <template if:true={get_congaSolutionsFound}>
                    <div class="sectionHeader slds-var-m-horizontal_large slds-var-m-top_medium lds-var-m-bottom_x-small">
                        <lightning-icon icon-name="utility:component_customization" size="x-small"></lightning-icon>
                        <span title="Conga Solutions" class="slds-var-m-left_x-small">Conga Solutions</span>
                    </div>
                    <template for:each={congaSolutions} for:item="solution">
                        <div key={solution.Id} class="searchResultContainer slds-var-m-horizontal_large">

                            <lightning-layout horizontal-align="spread">       
                                <lightning-layout-item size="7" class=""> 
                                    <p class="slds-truncate"><b>Solution: </b>{solution.Name}</p>
                                    <!-- <p class="slds-truncate"><b>To: </b>{email.ToAddress}</p> -->

                                </lightning-layout-item>
                                <lightning-layout-item size="4" class="">
                                        <div class="slds-grid slds-grid_align-end">
                                            <div class="slds-col slds-var-m-right_small">
                                                <div class="statContainerTask">
                                                    <lightning-formatted-date-time value={solution.LastMofidiedDate} title="Last Modified Date"></lightning-formatted-date-time>
                                                </div> 
                                            </div>
                                            <!-- <template if:true={email.hasEmailTemplateID}> -->
                                                <div class="slds-col slds-var-m-right_xx-small">
                                                    <lightning-button-icon 
                                                        icon-name="utility:component_customization" 
                                                        variant="border-filled" 
                                                        size="small" 
                                                        alternative-text="Go to Conga Solution" 
                                                        title="Go to Conga Solution"
                                                        onclick={goToRecord}
                                                        data-link={solution.solutionLink}>
                                                    </lightning-button-icon>
                                                </div>
                                            <!-- </template> -->
                                            
                                            <div class="slds-col">
                                                <lightning-button-icon 
                                                    icon-name="utility:button_choice" 
                                                    variant="border-filled" 
                                                    size="small" 
                                                    alternative-text="Go To Conga Button" 
                                                    title="Go To Conga Button"
                                                    onclick={goToRecord}
                                                    data-link={solution.solutionButtonLink}>
                                                </lightning-button-icon>
                                            </div>
                                        </div>
                                </lightning-layout-item>     
                            </lightning-layout>

                            <lightning-layout horizontal-align="spread" class="slds-var-m-top_small">       
                                <lightning-layout-item size="12" class="slds-truncate"> 
                                    <p class="slds-truncate sld-var-m-top_small" style="white-space:normal;">
                                        <b>Parameters: </b><lightning-formatted-text value={solution.APXTConga4__Button_body_field__c}></lightning-formatted-text>
                                    </p>
                                </lightning-layout-item>    
                            </lightning-layout>
                        </div>
                    </template>
                </template>

                <template if:false={get_congaSolutionsFound}>
                    <template if:true={filterCongaSolutions}>
                        <div class="slds-var-m-horizontal_large slds-var-m-bottom_large slds-var-m-top_medium">
                            <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                            &nbsp; No Conga Solutions Found...
                        </div>
                    </template>
                </template>
            </div>

        </template>






        <!-- STRING SEARCH RESULTS-->
        <template lwc:if={searchingForMessage}>
            <div class="searchCriteriaContainer slds-var-m-horizontal_large">
                <div class="slds-grid">
                    <div class="slds-col slds-size_1-of-1 slds-truncate">
                        <lightning-icon icon-name="utility:text" size="x-small"></lightning-icon>
                        <span title={searchingForMessage} class="slds-var-m-left_x-small slds-var-m-bottom_small">{searchingForMessage}</span>
                    </div>
                </div>
            </div>
            <div style="max-height: 500px" class="slds-scrollable_y">
                <div class="sectionHeader slds-var-m-horizontal_large slds-var-m-top_medium lds-var-m-bottom_x-small">
                    <lightning-icon icon-name="utility:email" size="x-small"></lightning-icon>
                    <span title="Email Messages" class="slds-var-m-left_x-small">Email Messages</span>
                </div>
                <template for:each={emailMessages} for:item="email">
                    <div key={email.Id} class="searchResultContainer slds-var-m-horizontal_large">

                        <lightning-layout horizontal-align="spread">       
                            <lightning-layout-item size="7" class=""> 
                                <p class="slds-truncate"><b>From: </b>{email.FromAddress}</p>
                                <p class="slds-truncate"><b>To: </b>{email.ToAddress}</p>

                            </lightning-layout-item>
                            <lightning-layout-item size="4" class="">
                                    <div class="slds-grid slds-grid_align-end">
                                        <div class="slds-col slds-var-m-right_small">
                                            <div class="statContainerTask">
                                                <lightning-formatted-date-time value={email.MessageDate} title="Email Sent Date"></lightning-formatted-date-time>
                                            </div> 
                                        </div>
                                        <template if:true={email.hasEmailTemplateID}>
                                            <div class="slds-col slds-var-m-right_x-small">
                                                <lightning-button-icon 
                                                    icon-name="utility:component_customization" 
                                                    variant="border-filled" 
                                                    size="small" 
                                                    alternative-text="Go to Email Template Id" 
                                                    title="Go to Email Template ID"
                                                    onclick={goToRecord}
                                                    data-link={email.emailTemplateLink}>
                                                </lightning-button-icon>
                                            </div>
                                        </template>
                                        
                                        <div class="slds-col">
                                            <lightning-button-icon 
                                                icon-name="utility:email" 
                                                variant="border-filled" 
                                                size="small" 
                                                alternative-text="View Email" 
                                                title="View Email"
                                                onclick={goToRecord}
                                                data-link={email.emailMessageLink}>
                                            </lightning-button-icon>
                                        </div>
                                    </div>
                            </lightning-layout-item>     
                        </lightning-layout>

                        <lightning-layout horizontal-align="spread" class="slds-var-m-top_small">       
                            <lightning-layout-item size="12" class="slds-truncate"> 
                                <p class="slds-truncate sld-var-m-top_small" style="white-space:normal;">
                                    <b>Subject: </b><lightning-formatted-text value={email.Subject}></lightning-formatted-text>
                                </p>
                            </lightning-layout-item>    
                        </lightning-layout>
                    </div>
                </template>

                <template if:false={get_emailMessagesFound}>
                    <div class="slds-var-m-horizontal_large slds-var-m-bottom_large slds-var-m-top_medium">
                        <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                        &nbsp; No Messages Found...
                    </div>
                </template>


                <!-- CONGA SOLUTIONS -->
                <template if:true={get_congaSolutionsFound}>
                    <div class="sectionHeader slds-var-m-horizontal_large slds-var-m-top_medium lds-var-m-bottom_x-small">
                        <lightning-icon icon-name="utility:email" size="x-small"></lightning-icon>
                        <span title="Conga Solutions" class="slds-var-m-left_x-small">Conga Solutions</span>
                    </div>
                    <template for:each={congaSolutions} for:item="solution">
                        <div key={solution.Id} class="searchResultContainer slds-var-m-horizontal_large">

                            <lightning-layout horizontal-align="spread">       
                                <lightning-layout-item size="7" class=""> 
                                    <p class="slds-truncate"><b>Solution: </b>{solution.Name}</p>
                                    <!-- <p class="slds-truncate"><b>To: </b>{email.ToAddress}</p> -->

                                </lightning-layout-item>
                                <lightning-layout-item size="4" class="">
                                        <div class="slds-grid slds-grid_align-end">
                                            <div class="slds-col slds-var-m-right_small">
                                                <div class="statContainerTask">
                                                    <lightning-formatted-date-time value={solution.LastMofidiedDate} title="Last Modified Date"></lightning-formatted-date-time>
                                                </div> 
                                            </div>
                                            <!-- <template if:true={email.hasEmailTemplateID}> -->
                                                <div class="slds-col slds-var-m-right_xx-small">
                                                    <lightning-button-icon 
                                                        icon-name="utility:component_customization" 
                                                        variant="border-filled" 
                                                        size="small" 
                                                        alternative-text="Go to Conga Solution" 
                                                        title="Go to Conga Solution"
                                                        onclick={goToRecord}
                                                        data-link={solution.solutionLink}>
                                                    </lightning-button-icon>
                                                </div>
                                            <!-- </template> -->
                                            
                                            <div class="slds-col">
                                                <lightning-button-icon 
                                                    icon-name="utility:button_choice" 
                                                    variant="border-filled" 
                                                    size="small" 
                                                    alternative-text="Go To Conga Button" 
                                                    title="Go To Conga Button"
                                                    onclick={goToRecord}
                                                    data-link={solution.solutionButtonLink}>
                                                </lightning-button-icon>
                                            </div>
                                        </div>
                                </lightning-layout-item>     
                            </lightning-layout>

                            <lightning-layout horizontal-align="spread" class="slds-var-m-top_small">       
                                <lightning-layout-item size="12" class="slds-truncate"> 
                                    <p class="slds-truncate sld-var-m-top_small" style="white-space:normal;">
                                        <b>Parameters: </b><lightning-formatted-text value={solution.APXTConga4__Button_body_field__c}></lightning-formatted-text>
                                    </p>
                                </lightning-layout-item>    
                            </lightning-layout>
                        </div>
                    </template>
                </template>

                <template if:false={get_congaSolutionsFound}>
                    <template if:true={filterCongaSolutions}>
                        <div class="slds-var-m-horizontal_large slds-var-m-bottom_large slds-var-m-top_medium">
                            <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                            &nbsp; No Conga Solutions Found...
                        </div>
                    </template>
                </template>
            </div>


        </template>
        
        
        <!-- ERROR MESSAGES / FEEDBACK -->
        <template if:true={showUserSearchFeedback}>
            <div class="slds-var-m-horizontal_large slds-var-m-bottom_large">
                <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                &nbsp; No Users Found...
            </div>
            <div class="slds-var-m-horizontal_large slds-var-m-bottom_large feedbackContainer"
                onclick={searchEmailsWithTerm}>
                <lightning-icon icon-name="utility:search" size="x-small"></lightning-icon>
                &nbsp; &nbsp; Click here to search emails directly for '<b>{searchTerm}</b>'
            </div>
            <div class="slds-var-m-horizontal_large slds-var-m-bottom_large">
            </div>
        </template>
        

        <!-- <div slot="footer">
                <lightning-badge label="Tag1"></lightning-badge>
                <lightning-badge label="Tag2"></lightning-badge>
                <lightning-badge label="Tag3"></lightning-badge>
        </div> -->
    </lightning-card>
</template>